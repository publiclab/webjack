var WebJack={};!function(a){"undefined"==typeof module?a=WebJack:module.exports=WebJack}("undefined"==typeof exports?this.WebJack={}:exports),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),WebJack.Decoder=Class.extend({init:function(a){function b(a){for(var b=Math.max.apply(null,a),c=0;c<a.length;c++)a[c]/=b}function c(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b}function d(a,b){for(var c=b;c<a.length-b;c++){for(var d=-b;d<=b;d++)a[c]+=a[c+d];a[c]/=2*b+1,k&&(j+=a[c]+"\n")}}function e(a){var e,f,g=a,h=[];b(g);for(var i=r.c,j=0;j<g.length;j++)s[i]=g[j]*y[i],t[i]=g[j]*w[i],u[i]=g[j]*z[i],v[i]=g[j]*x[i],e=Math.sqrt(Math.pow(c(s),2)+Math.pow(c(t),2)),f=Math.sqrt(Math.pow(c(u),2)+Math.pow(c(v),2)),g[j]=f-e,i++,i==p/2&&(i=0);r.c=i,d(g,1);for(var j=1;j<g.length;j++){if(g[j]*g[j-1]<0||0==g[j-1]){var k=Math.round((r.t-r.lastTransition)/p);r.lastTransition=r.t,h.push(k)}r.t++}return r.t++,h}function f(a,b){if(r.bitCounter+b>8)throw"byteBuffer too small";for(var c=0;c<b;c++)r.bitCounter++,r.byteBuffer>>>=1,a&&(r.byteBuffer|=128),8==r.bitCounter&&(r.wordBuffer.push(r.byteBuffer),r.byteBuffer=0)}function g(a){var b="";a.length&&(a.forEach(function(a){b+=String.fromCharCode(a)}),a.length=0),i(b)}var h=this,i=a.onReceive,j="",k=a.debug,l=a.baud,m=a.freqLow,n=a.freqHigh,o=a.sampleRate,p=Math.ceil(o/l),q=Math.ceil(40*o/1e3/p),r={current:0,PREAMBLE:1,START:2,DATA:3,STOP:4,bitCounter:0,byteBuffer:0,wordBuffer:[],lastTransition:0,lastBitState:0,t:0,c:0},s=new Float32Array(p/2),t=new Float32Array(p/2),u=new Float32Array(p/2),v=new Float32Array(p/2),w=new Float32Array(p/2),x=new Float32Array(p/2),y=new Float32Array(p/2),z=new Float32Array(p/2);!function(){for(var a=2*Math.PI*(m/o),b=2*Math.PI*(n/o),c=0;c<p/2;c++)w[c]=Math.sin(a*c),x[c]=Math.sin(b*c),y[c]=Math.cos(a*c),z[c]=Math.cos(b*c)}();var A=a.raw?i:g;h.decode=function(a){for(var b=e(a),c=r.PREAMBLE,d=0;d<b.length;d++){var g=b[d];switch(r.current){case r.PREAMBLE:g>=12&&g<=q+20&&(c=r.START,r.lastBitState=0,r.byteBuffer=0,r.wordBuffer=[]);break;case r.START:k&&console.log("START"),r.bitCounter=0,1==g?c=r.DATA:g>1&&g<=9?(c=9==g?r.STOP:r.DATA,f(0,g-1)):c=r.PREAMBLE;break;case r.DATA:k&&console.log("DATA");var h=g+r.bitCounter,i=1^r.lastBitState;h>11?c=r.PREAMBLE:11==h?(f(1,g-3),c=r.START,k&&console.log(">emit< "+r.wordBuffer[0].toString(2)),A(r.wordBuffer),r.wordBuffer=[]):10==h?(f(1,g-2),c=r.PREAMBLE,k&&console.log("|emit| "+r.wordBuffer[0].toString(2)),A(r.wordBuffer)):9==h?(f(1,g-1),c=r.START):8==h?(f(i,g),c=r.STOP,r.lastBitState=i):(f(i,g),c=r.DATA,r.lastBitState=i),0==g&&(c=r.PREAMBLE,k&&console.log("#demod error#"));break;case r.STOP:k&&console.log(" STOP"),1==g?c=r.START:3==g?(c=r.START,k&&console.log(">>emit<< "+r.wordBuffer[0].toString(2)),A(r.wordBuffer),r.wordBuffer=[]):g>=2?(c=r.PREAMBLE,k&&console.log("||emit|| "+r.wordBuffer[0].toString(2)),A(r.wordBuffer)):c=r.PREAMBLE;break;default:c=r.PREAMBLE,r.bitCounter=0,r.byteBuffer=0}r.current=c}k&&(j="")}}}),WebJack.Encoder=Class.extend({init:function(a){function b(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);if(d<=127)b.push(d);else if(d<=2047)b.push(192|d>>>6),b.push(128|63&d);else if(d<=65535)b.push(224|d>>>12),b.push(128|d>>>6&63),b.push(128|63&d);else{for(var e=4;d>>>6*e;)e++;for(b.push(65280>>>e&255|d>>>6*--e);e--;)b[idx++]=128|d>>>6*e&63}}return b}var c=this,d=44100,e=a.sampleRate,f=a.baud,g=a.freqLow,h=a.freqHigh,i=Math.ceil(d/f),j=(Math.ceil(d/g),Math.ceil(d/h),Math.ceil(40*d/1e3/i)),k=a.softmodem?1:2,l=new Float32Array(i),m=new Float32Array(i);!function(){for(var a=2*Math.PI*g/d,b=2*Math.PI*h/d,c=0;c<i;c++)l.set([Math.cos(a*c)],c),m.set([Math.cos(b*c)],c)}(),c.modulate=function(c){function f(a,b){for(var c=0;c<b;c++)n.set(a?m:l,o),o+=i}var g=a.raw?c:b(c),h=(j+10*g.length+k)*i,n=new Float32Array(h),o=0;f(1,j);for(var p=0;p<g.length;p++)for(var q=g[p]<<1|512,r=0;r<10;r++,q>>=1)f(1&q,1);f(1,1),a.softmodem||f(0,1),a.debug&&console.log("gen. audio length: "+n.length);var s=new WebJack.Resampler({inRate:d,outRate:e,inputBuffer:n});s.resample(n.length);var t=s.outputBuffer();return a.debug&&console.log("resampled audio length: "+t.length),t}}}),WebJack.Profiles={SoftModem:{baud:1225,freqLow:4900,freqHigh:7350,echoCancellation:!1,softmodem:!0},SoftModemLowFrequencies:{baud:1225,freqLow:2450,freqHigh:4900,echoCancellation:!0,softmodem:!0},Browser:{baud:1225,freqLow:19600,freqHigh:20825,echoCancellation:!1,softmodem:!1}},WebJack.Resampler=Class.extend({init:function(a){function b(a){var b=0;if(a>0){var c=h,d=0,e=0,j=0,b=0;for(c-=1,a-=1,j=Math.floor(c);j<a;)e=c%1,d=1-e,f[b++]=o[j]*d+o[j+1]*e,c+=g,j=Math.floor(c);i[0]=o[j++],h=c%1}return b}function c(){var a=0;if(bufferLength>0){var b=0,c=0,d=0,e=0,k=!j;j=!1;var l=0;do{for(k?(b=g,c=0):(b=h,c=i[0],k=!0);b>0&&d<bufferLength;){if(e=1+d-l,!(b>=e)){c+=o[d]*b,l+=b,b=0;break}c+=o[d++]*e,l=d,b-=e}if(!(b<=0)){h=b,i[0]=c,j=!0;break}f[a++]=c/g}while(d<bufferLength)}return a}function d(a){return a}function e(){var a=Math.ceil(o.length*n/m/1.0000004768371582)+1;try{f=new Float32Array(a),i=new Float32Array(1)}catch(a){f=[],i=[]}}var f,g,h,i,j,k,l=this,m=+a.inRate,n=+a.outRate,o=a.inputBuffer;if("object"!=typeof o)throw new Error("inputBuffer is not an object.");if(!(o instanceof Array||o instanceof Float32Array||o instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");if(!(m>0&&n>0))throw new Error("Invalid settings specified for the resampler.");m==n?(k=d,g=1,f=o):(e(),g=m/n,m<n?(k=b,h=1):(k=c,j=!1,h=0)),l.resample=function(a){return k(a)},l.outputBuffer=function(){return f}}}),WebJack.Connection=Class.extend({init:function(a){function b(a,b){return"undefined"==typeof a?b:a}function c(a){var b=a.inputBuffer,c=b.getChannelData(0);console.log("-- audioprocess data ("+c.length+" samples) --"),f||(j.onReceive=g,f=new WebJack.Decoder(j)),f.decode(c)}function d(a){var b=a.getAudioTracks();console.log("Using audio device: "+b[0].label),console.log("-- samplerate ("+j.sampleRate+") --"),a.active||console.log("Stream not active"),audioSource=i.createMediaStreamSource(a),decoderNode=i.createScriptProcessor(8192,1,1),audioSource.connect(decoderNode),decoderNode.addEventListener("audioprocess",c),decoderNode.connect(i.destination)}function e(a){console.log("navigator.getUserMedia error: ",a)}var f,g,h=this,a=b(a,WebJack.Profiles.SoftModem),i="undefined"==typeof a.audioCtx?new AudioContext:a.audioCtx,j={sampleRate:i.sampleRate,baud:b(a.baud,1225),freqLow:b(a.freqLow,4900),freqHigh:b(a.freqHigh,7350),debug:b(a.debug,!1),softmodem:b(a.softmodem,!0),raw:b(a.raw,!1),echoCancellation:b(a.echoCancellation,!1)},k=new WebJack.Encoder(j);navigator=a.navigator||navigator,navigator.mediaDevices.getUserMedia({audio:{optional:[{echoCancellation:j.echoCancellation}]},video:!1}).then(d,e),h.history={sent:[],received:[]};var l=[],m=!1;h.send=function(a){function b(a){var c=i.createBufferSource();c.buffer=a,c.connect(i.destination),m=!0,c.start(0),c.onended=function(){m=!1,l.length&&b(l.shift())}}var c=k.modulate(a),d=i.createBuffer(1,c.length,j.sampleRate);d.copyToChannel(c,0),m?l.push(d):b(d),h.history.sent.push(a)},h.listen=function(a){g=function(b){a(b),h.history.received.push(b)}},h.validateJSON=function(a){var b;try{b=JSON.parse(a)}catch(a){return!1}return b}}});
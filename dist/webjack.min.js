var WebJack={};"undefined"==typeof exports?this.WebJack={}:exports,"undefined"==typeof module||(module.exports=WebJack),function(){var a=!1,i=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(e){var n=this.prototype;a=!0;var t=new this;for(var o in a=!1,e)t[o]="function"==typeof e[o]&&"function"==typeof n[o]&&i.test(e[o])?function(o,r){return function(){var e=this._super;this._super=n[o];var t=r.apply(this,arguments);return this._super=e,t}}(o,e[o]):e[o];function r(){!a&&this.init&&this.init.apply(this,arguments)}return((r.prototype=t).constructor=r).extend=arguments.callee,r}}(),WebJack.Decoder=Class.extend({init:function(e){var t,o,r,n,u,f,s,c,l,d,h,p,g,v,a=this,w=e.debug,i=e.onReceive,b=e.sampleRate,A={current:0,PREAMBLE:1,START:2,DATA:3,STOP:4,bitCounter:0,byteBuffer:0,wordBuffer:[],lastTransition:0,lastBitState:0,t:0,c:0};function m(e){for(var t=0,o=0;o<e.length;o++)t+=e[o];return t}function B(e){var t,o,r=e,n=[];!function(e){for(var t=Math.max.apply(null,e),o=0;o<e.length;o++)e[o]/=t}(r);for(var a=A.c,i=0;i<r.length;i++)s[a]=r[i]*g[a],c[a]=r[i]*h[a],l[a]=r[i]*v[a],d[a]=r[i]*p[a],t=Math.sqrt(Math.pow(m(s),2)+Math.pow(m(c),2)),o=Math.sqrt(Math.pow(m(l),2)+Math.pow(m(d),2)),r[i]=o-t,++a==u/2&&(a=0);A.c=a,function(e,t){for(var o=t;o<e.length-t;o++){for(var r=-t;r<=t;r++)e[o]+=e[o+r];e[o]/=2*t+1,w&&e[o]+"\n"}}(r,1);for(i=1;i<r.length;i++){if(r[i]*r[i-1]<0||0==r[i-1]){var f=Math.round((A.t-A.lastTransition)/u);A.lastTransition=A.t,n.push(f)}A.t++}return A.t++,n}function y(e,t){if(8<A.bitCounter+t)throw"byteBuffer too small";for(var o=0;o<t;o++)A.bitCounter++,A.byteBuffer>>>=1,e&&(A.byteBuffer|=128),8==A.bitCounter&&(A.wordBuffer.push(A.byteBuffer),A.byteBuffer=0)}a.setProfile=function(e){o=e.baud,r=e.freqLow,n=e.freqHigh,u=Math.ceil(b/o),f=Math.ceil(40*b/1e3/u),s=new Float32Array(u/2),c=new Float32Array(u/2),l=new Float32Array(u/2),d=new Float32Array(u/2),h=new Float32Array(u/2),p=new Float32Array(u/2),g=new Float32Array(u/2),v=new Float32Array(u/2),function(){for(var e=2*Math.PI*(r/b),t=2*Math.PI*(n/b),o=0;o<u/2;o++)h[o]=Math.sin(e*o),p[o]=Math.sin(t*o),g[o]=Math.cos(e*o),v[o]=Math.cos(t*o)}(),t=void 0!==e.raw&&e.raw},a.setProfile(e);var M=t?i:function(e){var t="";e.length&&(e.forEach(function(e){t+=String.fromCharCode(e)}),e.length=0),i(t)};a.decode=function(e){for(var t=B(e),o=A.PREAMBLE,r=0;r<t.length;r++){var n=t[r];switch(A.current){case A.PREAMBLE:12<=n&&n<=f+20&&(o=A.START,A.lastBitState=0,A.byteBuffer=0,A.wordBuffer=[]);break;case A.START:w&&console.log("START"),A.bitCounter=0,1==n?o=A.DATA:1<n&&n<=9?(o=9==n?A.STOP:A.DATA,y(0,n-1)):o=A.PREAMBLE;break;case A.DATA:w&&console.log("DATA");var a=n+A.bitCounter,i=1^A.lastBitState;11<a?o=A.PREAMBLE:11==a?(y(1,n-3),o=A.START,w&&console.log(">emit< "+A.wordBuffer[0].toString(2)),M(A.wordBuffer),A.wordBuffer=[]):10==a?(y(1,n-2),o=A.PREAMBLE,w&&console.log("|emit| "+A.wordBuffer[0].toString(2)),M(A.wordBuffer)):9==a?(y(1,n-1),o=A.START):(o=8==a?(y(i,n),A.STOP):(y(i,n),A.DATA),A.lastBitState=i),0==n&&(o=A.PREAMBLE,w&&console.log("#demod error#"));break;case A.STOP:w&&console.log(" STOP"),1==n?o=A.START:3==n?(o=A.START,w&&console.log(">>emit<< "+A.wordBuffer[0].toString(2)),M(A.wordBuffer),A.wordBuffer=[]):2<=n?(o=A.PREAMBLE,w&&console.log("||emit|| "+A.wordBuffer[0].toString(2)),M(A.wordBuffer)):o=A.PREAMBLE;break;default:o=A.PREAMBLE,A.bitCounter=0,A.byteBuffer=0}A.current=o}}}}),WebJack.Encoder=Class.extend({init:function(l){var t,r,n,d,h,p,g,v,w,b,A=44100,m=l.sampleRate;this.setProfile=function(e){t=e.baud,r=e.freqLow,n=e.freqHigh,d=Math.ceil(A/t),h=Math.ceil(1764/d),p=e.softmodem?1:2,g=new Float32Array(d),v=new Float32Array(d),w=void 0!==e.raw&&e.raw,b=e.softmodem,function(){for(var e=2*Math.PI*r/A,t=2*Math.PI*n/A,o=0;o<d;o++)g.set([Math.cos(e*o)],o),v.set([Math.cos(t*o)],o)}(),console.log("new encoder profile: ",e)},this.setProfile(l),this.modulate=function(e){var t=w?e:function(e){for(var t=[],o=0;o<e.length;o++){var r=e.charCodeAt(o);if(r<=127)t.push(r);else if(r<=2047)t.push(192|r>>>6),t.push(128|63&r);else if(r<=65535)t.push(224|r>>>12),t.push(128|r>>>6&63),t.push(128|63&r);else{for(var n=4;r>>>6*n;)n++;for(t.push(65280>>>n&255|r>>>6*--n);n--;)t[idx++]=128|r>>>6*n&63}}return t}(e),o=(h+10*t.length+p)*d,r=new Float32Array(o),n=0;function a(e,t){for(var o=0;o<t;o++)r.set(e?v:g,n),n+=d}a(1,h);for(var i=0;i<t.length;i++)for(var f=t[i]<<1|512,u=0;u<10;u++,f>>=1)a(1&f,1);a(1,1),b||a(0,1),l.debug&&console.log("gen. audio length: "+r.length);var s=new WebJack.Resampler({inRate:A,outRate:m,inputBuffer:r});s.resample(r.length);var c=s.outputBuffer();return l.debug&&console.log("resampled audio length: "+c.length),c}}}),WebJack.Profiles={SoftModem:{baud:1225,freqLow:4900,freqHigh:7350,echoCancellation:!1,softmodem:!0},SoftModemLowFrequencies:{baud:1225,freqLow:2450,freqHigh:4900,echoCancellation:!0,softmodem:!0},Browser:{baud:1225,freqLow:19600,freqHigh:20825,echoCancellation:!1,softmodem:!1}},WebJack.Resampler=Class.extend({init:function(e){var f,u,s,c,l,t,o=+e.inRate,r=+e.outRate,d=e.inputBuffer;if("object"!=typeof d)throw new Error("inputBuffer is not an object.");if(!(d instanceof Array||d instanceof Float32Array||d instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");if(!(0<o&&0<r))throw new Error("Invalid settings specified for the resampler.");o==r?(t=function(e){return e},u=1,f=d):(function(){var e=Math.ceil(d.length*r/o/1.0000004768371582)+1;try{f=new Float32Array(e),c=new Float32Array(1)}catch(e){f=[],c=[]}}(),u=o/r,s=o<r?(t=function(e){var t=0;if(0<e){var o=s,r=0,n=0,a=0,t=0;for(o-=1,e-=1,a=Math.floor(o);a<e;)r=1-(n=o%1),f[t++]=d[a]*r+d[a+1]*n,o+=u,a=Math.floor(o);c[0]=d[a++],s=o%1}return t},1):(l=!(t=function(){var e=0;if(0<bufferLength){var t=0,o=0,r=0,n=0,a=!l;l=!1;var i=0;do{for(a?(t=u,o=0):(t=s,o=c[0],a=!0);0<t&&r<bufferLength;){if(!((n=1+r-i)<=t)){o+=d[r]*t,i+=t,t=0;break}o+=d[r++]*n,i=r,t-=n}if(!(t<=0)){s=t,c[0]=o,l=!0;break}f[e++]=o/u}while(r<bufferLength)}return e}),0)),this.resample=function(e){return t(e)},this.outputBuffer=function(){return f}}}),WebJack.Connection=Class.extend({init:function(e){var r=this;function t(e,t){return void 0===e?t:e}if(void 0===(e=t(e,WebJack.Profiles.SoftModem)).audioCtx){AudioContext=t(AudioContext,webkitAudioContext);var n=new AudioContext}else n=e.audioCtx;var o,a,i=r.options={sampleRate:n.sampleRate,baud:t(e.baud,1225),freqLow:t(e.freqLow,4900),freqHigh:t(e.freqHigh,7350),debug:t(e.debug,!1),softmodem:t(e.softmodem,!0),raw:t(e.raw,!1),echoCancellation:t(e.echoCancellation,!1)},f=new WebJack.Encoder(i);function u(e){var t=e.inputBuffer.getChannelData(0);console.log("-- audioprocess data ("+t.length+" samples) --"),o||(i.onReceive=a,o=new WebJack.Decoder(i)),o.decode(t)}navigator=e.navigator||navigator,navigator.mediaDevices.getUserMedia({audio:{optional:[{echoCancellation:i.echoCancellation}]},video:!1}).then(function(e){var t=e.getAudioTracks();console.log("Using audio device: "+t[0].label),console.log("-- samplerate ("+i.sampleRate+") --"),e.active||console.log("Stream not active"),audioSource=n.createMediaStreamSource(e),decoderNode=n.createScriptProcessor(8192,1,1),audioSource.connect(decoderNode),decoderNode.addEventListener("audioprocess",u),decoderNode.connect(n.destination)},function(e){console.log("navigator.getUserMedia error: ",e)}),r.history={sent:[],received:[]};var s=[],c=!1;r.send=function(e){var t=f.modulate(e),o=n.createBuffer(1,t.length,i.sampleRate);o.getChannelData(0).set(t),c?s.push(o):function e(t){var o=n.createBufferSource();o.buffer=t,o.connect(n.destination),c=!0,o.start(0),o.onended=function(){c=!1,s.length&&e(s.shift())}}(o),r.history.sent.push(e)},r.listen=function(t){a=function(e){t(e),r.history.received.push(e)}},r.validateJSON=function(e){var t;try{t=JSON.parse(e)}catch(e){return!1}return t},r.setProfile=function(e){f.setProfile(e),"object"==typeof o&&o.setProfile(e)},r.setBaud=function(e){r.options.baud=e,r.setProfile(r.options)},r.setFrequencies=function(e,t){r.options.freqHigh=e,r.options.freqLow=t,r.setProfile(r.options)}}});
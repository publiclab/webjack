var WebJack={};!function(a){"undefined"==typeof module?a=WebJack:module.exports=WebJack}("undefined"==typeof exports?this.WebJack={}:exports),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),WebJack.Decoder=Class.extend({init:function(a){function b(a){for(var b=Math.max.apply(null,a),c=0;c<a.length;c++)a[c]/=b}function c(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b}function d(a,b){for(var c=b;c<a.length-b;c++){for(var d=-b;d<=b;d++)a[c]+=a[c+d];a[c]/=2*b+1,w&&(x+=a[c]+"\n")}}function e(a){var e,f,g=a,h=[];b(g);for(var i=A.c,j=0;j<g.length;j++)n[i]=g[j]*t[i],o[i]=g[j]*r[i],p[i]=g[j]*u[i],q[i]=g[j]*s[i],e=Math.sqrt(Math.pow(c(n),2)+Math.pow(c(o),2)),f=Math.sqrt(Math.pow(c(p),2)+Math.pow(c(q),2)),g[j]=f-e,i++,i==l/2&&(i=0);A.c=i,d(g,1);for(var j=1;j<g.length;j++){if(g[j]*g[j-1]<0||0==g[j-1]){var k=Math.round((A.t-A.lastTransition)/l);A.lastTransition=A.t,h.push(k)}A.t++}return A.t++,h}function f(a,b){if(A.bitCounter+b>8)throw"byteBuffer too small";for(var c=0;c<b;c++)A.bitCounter++,A.byteBuffer>>>=1,a&&(A.byteBuffer|=128),8==A.bitCounter&&(A.wordBuffer.push(A.byteBuffer),A.byteBuffer=0)}function g(a){var b="";a.length&&(a.forEach(function(a){b+=String.fromCharCode(a)}),a.length=0),y(b)}var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this,w=a.debug,x="",y=a.onReceive,z=a.sampleRate,A={current:0,PREAMBLE:1,START:2,DATA:3,STOP:4,bitCounter:0,byteBuffer:0,wordBuffer:[],lastTransition:0,lastBitState:0,t:0,c:0};v.setProfile=function(a){i=a.baud,j=a.freqLow,k=a.freqHigh,l=Math.ceil(z/i),m=Math.ceil(40*z/1e3/l),n=new Float32Array(l/2),o=new Float32Array(l/2),p=new Float32Array(l/2),q=new Float32Array(l/2),r=new Float32Array(l/2),s=new Float32Array(l/2),t=new Float32Array(l/2),u=new Float32Array(l/2),function(){for(var a=2*Math.PI*(j/z),b=2*Math.PI*(k/z),c=0;c<l/2;c++)r[c]=Math.sin(a*c),s[c]=Math.sin(b*c),t[c]=Math.cos(a*c),u[c]=Math.cos(b*c)}(),h="undefined"!=typeof a.raw&&a.raw},v.setProfile(a);var B=h?y:g;v.decode=function(a){for(var b=e(a),c=A.PREAMBLE,d=0;d<b.length;d++){var g=b[d];switch(A.current){case A.PREAMBLE:g>=12&&g<=m+20&&(c=A.START,A.lastBitState=0,A.byteBuffer=0,A.wordBuffer=[]);break;case A.START:w&&console.log("START"),A.bitCounter=0,1==g?c=A.DATA:g>1&&g<=9?(c=9==g?A.STOP:A.DATA,f(0,g-1)):c=A.PREAMBLE;break;case A.DATA:w&&console.log("DATA");var h=g+A.bitCounter,i=1^A.lastBitState;h>11?c=A.PREAMBLE:11==h?(f(1,g-3),c=A.START,w&&console.log(">emit< "+A.wordBuffer[0].toString(2)),B(A.wordBuffer),A.wordBuffer=[]):10==h?(f(1,g-2),c=A.PREAMBLE,w&&console.log("|emit| "+A.wordBuffer[0].toString(2)),B(A.wordBuffer)):9==h?(f(1,g-1),c=A.START):8==h?(f(i,g),c=A.STOP,A.lastBitState=i):(f(i,g),c=A.DATA,A.lastBitState=i),0==g&&(c=A.PREAMBLE,w&&console.log("#demod error#"));break;case A.STOP:w&&console.log(" STOP"),1==g?c=A.START:3==g?(c=A.START,w&&console.log(">>emit<< "+A.wordBuffer[0].toString(2)),B(A.wordBuffer),A.wordBuffer=[]):g>=2?(c=A.PREAMBLE,w&&console.log("||emit|| "+A.wordBuffer[0].toString(2)),B(A.wordBuffer)):c=A.PREAMBLE;break;default:c=A.PREAMBLE,A.bitCounter=0,A.byteBuffer=0}A.current=c}}}}),WebJack.Encoder=Class.extend({init:function(a){function b(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);if(d<=127)b.push(d);else if(d<=2047)b.push(192|d>>>6),b.push(128|63&d);else if(d<=65535)b.push(224|d>>>12),b.push(128|d>>>6&63),b.push(128|63&d);else{for(var e=4;d>>>6*e;)e++;for(b.push(65280>>>e&255|d>>>6*--e);e--;)b[idx++]=128|d>>>6*e&63}}return b}var c,d,e,f,g,h,i,j,k,l,m=this,n=44100,o=a.sampleRate;m.setProfile=function(a){c=a.baud,d=a.freqLow,e=a.freqHigh,f=Math.ceil(n/c),g=Math.ceil(40*n/1e3/f),h=a.softmodem?1:2,i=new Float32Array(f),j=new Float32Array(f),k="undefined"!=typeof a.raw&&a.raw,l=a.softmodem,function(){for(var a=2*Math.PI*d/n,b=2*Math.PI*e/n,c=0;c<f;c++)i.set([Math.cos(a*c)],c),j.set([Math.cos(b*c)],c)}(),console.log("new encoder profile: ",a)},m.setProfile(a),m.modulate=function(c){function d(a,b){for(var c=0;c<b;c++)p.set(a?j:i,q),q+=f}var e=k?c:b(c),m=(g+10*e.length+h)*f,p=new Float32Array(m),q=0;d(1,g);for(var r=0;r<e.length;r++)for(var s=e[r]<<1|512,t=0;t<10;t++,s>>=1)d(1&s,1);d(1,1),l||d(0,1),a.debug&&console.log("gen. audio length: "+p.length);var u=new WebJack.Resampler({inRate:n,outRate:o,inputBuffer:p});u.resample(p.length);var v=u.outputBuffer();return a.debug&&console.log("resampled audio length: "+v.length),v}}}),WebJack.Profiles={SoftModem:{baud:1225,freqLow:4900,freqHigh:7350,echoCancellation:!1,softmodem:!0},SoftModemLowFrequencies:{baud:1225,freqLow:2450,freqHigh:4900,echoCancellation:!0,softmodem:!0},Browser:{baud:1225,freqLow:19600,freqHigh:20825,echoCancellation:!1,softmodem:!1}},WebJack.Resampler=Class.extend({init:function(a){function b(a){var b=0;if(a>0){var c=h,d=0,e=0,j=0,b=0;for(c-=1,a-=1,j=Math.floor(c);j<a;)e=c%1,d=1-e,f[b++]=o[j]*d+o[j+1]*e,c+=g,j=Math.floor(c);i[0]=o[j++],h=c%1}return b}function c(){var a=0;if(bufferLength>0){var b=0,c=0,d=0,e=0,k=!j;j=!1;var l=0;do{for(k?(b=g,c=0):(b=h,c=i[0],k=!0);b>0&&d<bufferLength;){if(e=1+d-l,!(b>=e)){c+=o[d]*b,l+=b,b=0;break}c+=o[d++]*e,l=d,b-=e}if(!(b<=0)){h=b,i[0]=c,j=!0;break}f[a++]=c/g}while(d<bufferLength)}return a}function d(a){return a}function e(){var a=Math.ceil(o.length*n/m/1.0000004768371582)+1;try{f=new Float32Array(a),i=new Float32Array(1)}catch(a){f=[],i=[]}}var f,g,h,i,j,k,l=this,m=+a.inRate,n=+a.outRate,o=a.inputBuffer;if("object"!=typeof o)throw new Error("inputBuffer is not an object.");if(!(o instanceof Array||o instanceof Float32Array||o instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");if(!(m>0&&n>0))throw new Error("Invalid settings specified for the resampler.");m==n?(k=d,g=1,f=o):(e(),g=m/n,m<n?(k=b,h=1):(k=c,j=!1,h=0)),l.resample=function(a){return k(a)},l.outputBuffer=function(){return f}}}),WebJack.Connection=Class.extend({init:function(a){function b(a,b){return"undefined"==typeof a?b:a}function c(a){var b=a.inputBuffer,c=b.getChannelData(0);console.log("-- audioprocess data ("+c.length+" samples) --"),f||(j.onReceive=g,f=new WebJack.Decoder(j)),f.decode(c)}function d(a){var b=a.getAudioTracks();console.log("Using audio device: "+b[0].label),console.log("-- samplerate ("+j.sampleRate+") --"),a.active||console.log("Stream not active"),audioSource=i.createMediaStreamSource(a),decoderNode=i.createScriptProcessor(8192,1,1),audioSource.connect(decoderNode),decoderNode.addEventListener("audioprocess",c),decoderNode.connect(i.destination)}function e(a){console.log("navigator.getUserMedia error: ",a)}var f,g,h=this,a=b(a,WebJack.Profiles.SoftModem),i="undefined"==typeof a.audioCtx?new AudioContext:a.audioCtx,j=h.options={sampleRate:i.sampleRate,baud:b(a.baud,1225),freqLow:b(a.freqLow,4900),freqHigh:b(a.freqHigh,7350),debug:b(a.debug,!1),softmodem:b(a.softmodem,!0),raw:b(a.raw,!1),echoCancellation:b(a.echoCancellation,!1)},k=new WebJack.Encoder(j);navigator=a.navigator||navigator,navigator.mediaDevices.getUserMedia({audio:{optional:[{echoCancellation:j.echoCancellation}]},video:!1}).then(d,e),h.history={sent:[],received:[]};var l=[],m=!1;h.send=function(a){function b(a){var c=i.createBufferSource();c.buffer=a,c.connect(i.destination),m=!0,c.start(0),c.onended=function(){m=!1,l.length&&b(l.shift())}}var c=k.modulate(a),d=i.createBuffer(1,c.length,j.sampleRate);d.copyToChannel(c,0),m?l.push(d):b(d),h.history.sent.push(a)},h.listen=function(a){g=function(b){a(b),h.history.received.push(b)}},h.validateJSON=function(a){var b;try{b=JSON.parse(a)}catch(a){return!1}return b},h.setProfile=function(a){k.setProfile(a),"object"==typeof f&&f.setProfile(a)}}});